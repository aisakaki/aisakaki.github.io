<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  
  <title itemprop="name">多级中文域名解析系统-1（c语言） | 宵晓咲</title>
  
    <link rel="shortcut icon" href="/images/img/apple-touch-icon-next.png">
  
  <meta http-equiv="x-dns-prefetch-control" content="on">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+SerifMerriweather|Merriweather+Sans|Source+Code+Pro|Ubuntu:400,700|Noto+Serif+SC" media="all">
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
  <link rel="stylesheet" id="saukra_css-css" href="/css/style.css" type="text/css" media="all">
  <link rel="stylesheet" href="/css/lib.min.css" media="all">
  <link rel="stylesheet" href="/css/font.css" media="all">
  <link rel="stylesheet" href="/css/insight.css" media="all">
  <link rel="stylesheet" href="/css/jquery.fancybox.min.css" media="all">
  <link rel="stylesheet" href="/css/zoom.css" media="all">
  <link rel="stylesheet" type="text/css" href="/css/sharejs.css">
<!--   <link rel="stylesheet" id="saukra_css-css" href="https://2heng.xin/wp-content/cache/autoptimize/css/autoptimize_ad42a61f4c7d4bdd9f91afcff6b5dda5.css
" type="text/css" media="all"> -->
  <script>
  /*Initial Variables*/
  var mashiro_option = new Object();
  var mashiro_global = new Object();
  mashiro_option.NProgressON = true;
  /* 
   * 邮箱信息之类的东西可以填在这里，这些js变量基本都作用于sakura-app.js
   * 这样的设置仅是为了方便在基于PHP开发的主题中设置js变量，既然移植到了Node上，我想或许可以精简这一逻辑吧
   */
  mashiro_option.email_domain = "";
  mashiro_option.email_name = "";
  mashiro_option.cookie_version_control = "";
  mashiro_option.qzone_autocomplete = false;
  mashiro_option.site_name = "宵晓咲";
  mashiro_option.author_name = "宵晓咲";
  mashiro_option.site_url = "https://aisaka.cloud";
  mashiro_option.v_appId = "d2ULHdiL7VOfJf17rpCD4DOX-gzGzoHsz";
  mashiro_option.v_appKey = "OLf7QaP1oTtqKhulLHuajYKu";
  mashiro_option.mathjax = "1";
  mashiro_option.qq_api_url = "https://api.mashiro.top/qqinfo/"; 
  mashiro_option.qq_avatar_api_url = "https://api.mashiro.top/qqinfo/";

  // mashiro_option.jsdelivr_css_src = "https://cdn.jsdelivr.net/gh/moezx/cdn@3.4.5/css/lib.min.css";
  // mashiro_option.float_player_on = true;

  /*End of Initial Variables*/
  </script>
  <script type="text/javascript">
  var bg = "/images/img/85335083_p0.jpg".split(",");
  var bgindex = Math.floor(Math.random()*bg.length);
  if (!!window.ActiveXObject || "ActiveXObject" in window) { //is IE?
    alert('朋友，IE浏览器未适配哦~');
  }
  </script>
  <style type="text/css">
  .hljs-ln{border-collapse:collapse}.hljs-ln td{padding:0}.hljs-ln-n:before{content:attr(data-line-number)}
  </style>
  <style type="text/css">.site-top .lower nav{display:block !important;}.author-profile i,.post-like a,.post-share .show-share,.sub-text,.we-info a,span.sitename,.post-more i:hover,#pagination a:hover,.post-content a:hover,.float-content i:hover{color:#FE9600}.feature i,.download,.navigator i:hover,.links ul li:before,.ar-time i,span.ar-circle,.object,.comment .comment-reply-link,.siren-checkbox-radio:checked + .siren-checkbox-radioInput:after{background:#FE9600}::-webkit-scrollbar-thumb{background:#FE9600}.download,.navigator i:hover,.link-title,.links ul li:hover,#pagination a:hover,.comment-respond input[type='submit']:hover{border-color:#FE9600}.entry-content a:hover,.site-info a:hover,.comment h4 a,#comments-navi a.prev,#comments-navi a.next,.comment h4 a:hover,.site-top ul li a:hover,.entry-title a:hover,#archives-temp h3,span.page-numbers.current,.sorry li a:hover,.site-title a:hover,i.iconfont.js-toggle-search.iconsearch:hover,.comment-respond input[type='submit']:hover{color:#FE9600}.comments .comments-main{display:block !important;}.comments .comments-hidden{display:none !important;}background-position:center center;background-attachment:inherit;}
  </style>
</head>
</html>
<body class="page-template page-template-user page-template-page-analytics page-template-userpage-analytics-php page page-id-1297 chinese-font serif isWebKit">
  <div class="scrollbar" id="bar">
  </div>
  <a href="#" class="cd-top faa-float animated"></a>
  <section id="main-container">
    <div class="headertop ">
  <div id="banner_wave_1"></div>
  <div id="banner_wave_2"></div>
  <figure id="centerbg" class="centerbg">
    <div class="focusinfo no-select">
      <div class="header-tou">
        <a href="https://aisaka.cloud">
          <img src="/images/img/000.jpg">
        </a>
      </div>
      <div class="header-info">
        <p>且听风吟</p>
        <div class="top-social_v2">
          <li id="bg-pre">
            <img class="flipx" src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/next-b.svg">
          </li>
          
            
              
                <li>
                  <a href="htt20081@126.com" target="_blank" class="social-github" title="email">
                    <img src="/images/icon/email.svg">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="https://music.163.com/#/user/home?id=28578795" target="_blank" class="social-github" title="wangyiyun">
                    <img src="/images/icon/wangyiyun.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="https://space.bilibili.com/741763" target="_blank" class="social-github" title="bilibili">
                    <img src="/images/icon/bilibili.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="https://steamcommunity.com/id/aisakaki/" target="_blank" class="social-github" title="steam">
                    <img src="/images/icon/steam.svg">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="https://bangumi.tv/user/aisakaki" target="_blank" class="social-github" title="bangumi">
                    <img src="/images/icon/bgm.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="https://my.playstation.com/profile/AISAKAKI" target="_blank" class="social-github" title="psn">
                    <img src="/images/icon/ps.png">
                  </a>
                </li>
              
            
          
          <li id="bg-next">
            <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/next-b.svg">
          </li>
        </div>
      </div>
    </div>
  </figure>
  <div id="video-container" style="">
    <video style="object-fit: fill" id="bgvideo" class="video" video-name="" src="" width="auto" preload="auto">
    </video>
    <div id="video-btn" class="loadvideo videolive">
    </div>
    <div id="video-add">
    </div>
    <div class="video-stu">
    </div>
  </div>
  <div class="headertop-down faa-float animated" onclick="headertop_down()">
    <span>
      <i class="fa fa-chevron-down" aria-hidden="true">
      </i>
    </span>
  </div>
</div>
    <div id="page" class="site wrapper">
      <header class="site-header no-select gizle sabit" role="banner">
  <div class="site-top">
    <div class="site-branding">
      <span class="site-title">
        <span class="logolink moe-mashiro">
          <a href="/">
            <span class="sakurasono"></span>
            <span class="shironeko">宵晓咲</span>
          </a>
        </span>
      </span>
    </div>
    <div class="searchbox search-form-submit">
      <i class="iconfont js-toggle-search iconsearch icon-search">
      </i>
    </div>
    <div id="show-nav" class="showNav mobile-fit">
      <div class="line line1">
      </div>
      <div class="line line2">
      </div>
      <div class="line line3">
      </div>
    </div>
    <div class="lower-cantiner">
      <div class="lower">
        <nav class="mobile-fit-control hide">
          <ul id="menu-new" class="menu">
            
              <li>
                <a href="/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  " aria-hidden="true"></i>
                    首页
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/archives">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-fort-awesome faa-shake" aria-hidden="true"></i>
                    时间线
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="javascript:;">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-archive faa-shake" aria-hidden="true"></i>
                    ACG
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/categories/Anime/">
                          <i class="fa " aria-hidden="true"></i>
                          动画
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/Game/">
                          <i class="fa " aria-hidden="true"></i>
                          游戏
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/Music/">
                          <i class="fa " aria-hidden="true"></i>
                          音乐
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/游戏设计/">
                          <i class="fa " aria-hidden="true"></i>
                          游戏设计
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="javascript:;">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-book faa-shake" aria-hidden="true"></i>
                    随想
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/categories/日记/">
                          <i class="fa " aria-hidden="true"></i>
                          日记
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/阅读/">
                          <i class="fa " aria-hidden="true"></i>
                          阅读
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/随笔/">
                          <i class="fa " aria-hidden="true"></i>
                          随笔
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="javascript:;">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-code faa-shake" aria-hidden="true"></i>
                    技术
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/categories/程序语言/">
                          <i class="fa " aria-hidden="true"></i>
                          程序
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/人工智能/">
                          <i class="fa " aria-hidden="true"></i>
                          人工智能
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/开发/">
                          <i class="fa " aria-hidden="true"></i>
                          开发
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/数据库与中间件/">
                          <i class="fa " aria-hidden="true"></i>
                          中间件
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/网络与云/">
                          <i class="fa " aria-hidden="true"></i>
                          网络
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/算法与数据结构/">
                          <i class="fa " aria-hidden="true"></i>
                          算法
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/计算机理论/">
                          <i class="fa " aria-hidden="true"></i>
                          CS
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/论文阅读笔记/">
                          <i class="fa " aria-hidden="true"></i>
                          论文
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="javascript:;">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-leaf faa-wrench" aria-hidden="true"></i>
                    其它
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/categories/硬件/">
                          <i class="fa " aria-hidden="true"></i>
                          硬件
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/博客/">
                          <i class="fa " aria-hidden="true"></i>
                          博客
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/工具/">
                          <i class="fa " aria-hidden="true"></i>
                          工具
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="javascript:;">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-list-ul faa-vertical" aria-hidden="true"></i>
                    清单
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/tags/悦读/">
                          <i class="fa fa-th-list faa-bounce" aria-hidden="true"></i>
                          书单
                        </a>
                      </li>
                    
                      <li>
                        <a href="/bangumi/">
                          <i class="fa fa-film faa-vertical" aria-hidden="true"></i>
                          番组
                        </a>
                      </li>
                    
                      <li>
                        <a href="/music/">
                          <i class="fa fa-headphones" aria-hidden="true"></i>
                          歌单
                        </a>
                      </li>
                    
                      <li>
                        <a href="/tags/图集/">
                          <i class="fa fa-photo" aria-hidden="true"></i>
                          图集
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="/comment/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-pencil-square-o faa-tada" aria-hidden="true"></i>
                    留言板
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/links/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-link faa-shake" aria-hidden="true"></i>
                    Link
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/about/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-meetup faa-shake" aria-hidden="true"></i>
                    我
                  </span>
                </a>
                
              </li>
            
          </ul>
        </nav>
      </div>
    </div>
  </div>
</header>

      <link rel="stylesheet" type="text/css" href="/css/sharejs.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
<div class="pattern-center-blank"></div>

<div id="content" class="site-content">
  <div id="primary" class="content-area">
    <main id="main" class="site-main" role="main">
      <article id="post-1" class="post-1 post type-post status-publish format-standard has-post-thumbnail hentry category-uncategorized">
        <div class="toc"></div>
        <!--<div class="toc-entry-content"><!-- 套嵌目录使用（主要为了支援评论）-->
        
          <header class="entry-header">
            <h1 class="entry-title">多级中文域名解析系统-1（c语言）</h1>
            <p class="entry-census">&nbsp;&nbsp;2018-4-5&nbsp;</p>

            <hr>
          </header>
        
        <div class="entry-content">
          <h2 id="Introduce"><a href="#Introduce" class="headerlink" title="Introduce"></a>Introduce</h2><ul>
<li><p>支持中文域名解析，支持缓存与多请求</p>
</li>
<li><p>遵循RFC1180标准，可被wireshark抓包检测到</p>
</li>
</ul>
<ul>
<li><p>本系统包含一个客户端，四个中间多级DNS，一个根DNS，一个本地DNS</p>
</li>
<li><p>难点在于①不用python而使用C语言必须写非常多的底层操作，主要集中在defAndTools库中②DNS请求的逻辑</p>
</li>
</ul>
<h2 id="Project-Structure"><a href="#Project-Structure" class="headerlink" title="Project Structure"></a>Project Structure</h2><div class="table-container">
<table>
<thead>
<tr>
<th>CODES</th>
<th>EXPLAINATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>defAndTools.h</td>
<td>此包为主要工具包，涉及网络中的核心底层的操作，是主要难点之一</td>
</tr>
<tr>
<td>LOCAL_DNS.c</td>
<td>本地DNS服务器核心逻辑，是本网络中的核心部件，是主要难点之一</td>
</tr>
<tr>
<td>Client.c</td>
<td>客户端主逻辑</td>
</tr>
<tr>
<td>ROOT_DNS.c</td>
<td>根域名解析服务器的逻辑代码</td>
</tr>
<tr>
<td>DNS1.c</td>
<td>第一级域名解析服务器主逻辑</td>
</tr>
<tr>
<td>DNS2.c</td>
<td>第二级域名解析服务器主逻辑</td>
</tr>
<tr>
<td>DNS3.c</td>
<td>第三级域名解析服务器主逻辑</td>
</tr>
<tr>
<td>DNS4.c</td>
<td>第四级域名解析服务器主逻辑</td>
</tr>
<tr>
<td>localServer.h</td>
<td>本地DNS服务器的参数设置</td>
</tr>
</tbody>
</table>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th>FILES</th>
<th>EXPLAINATION</th>
</tr>
</thead>
<tbody>
<tr>
<td>localCache.txt</td>
<td>本地DNS服务器的缓存</td>
</tr>
<tr>
<td>RRL1.txt</td>
<td>第一级域名解析服务器的缓存</td>
</tr>
<tr>
<td>RRL2.txt</td>
<td>第二级域名解析服务器的缓存</td>
</tr>
<tr>
<td>RRL3.txt</td>
<td>第三级域名解析服务器的缓存</td>
</tr>
<tr>
<td>RRL4.txt</td>
<td>第四级域名解析服务器的缓存</td>
</tr>
<tr>
<td>RRroot.txt</td>
<td>根域名解析服务器的缓存</td>
</tr>
</tbody>
</table>
</div>
<h2 id="defAndTools"><a href="#defAndTools" class="headerlink" title="defAndTools"></a>defAndTools</h2><p><em>此包为主要工具包，涉及网络中的底层的操作</em></p>
 <a id="more"></a>
<pre class=" language-lang-c"><code class="language-lang-c">#include <stdio.h>
#include <string.h>
#include <arpa/inet.h> 
#include <stdlib.h>

#define MAX_SIZE_OF_DOMAIN 100
#define SERVER_PORT 53
#define ROOT_SERVER_IP "127.0.0.3"

//用于储存域名方便处理的全局变量
char domain_temp[MAX_SIZE_OF_DOMAIN];
typedef struct DNS_Header
{
    unsigned short id;       //16位的消息ID标示一次正常的交互，该ID由消息请求者设置，消息响应者回复请求时带上该ID。
    unsigned short tag;      //tag要拆，并单独写一个生成tag函数
    unsigned short queryNum; //标示请求部分的条目数 
    unsigned short answerNum;//标示响应部分的资源记录数。如果响应消息中没有记录，则设置为0
    unsigned short authorNum;//标示权威部分的域名服务器资源记录数。如果响应消息中没有权威记录，则设置为0
    unsigned short addNum;   //标示额外部分的资源记录数。
}DNS_HEAD;

typedef struct DNS_Query
{
    char *name;              //请求的域名。
    unsigned short qtype;    //记录的类型 [A:0x0001] [NS:0x0002] [CNAME:0x0005] [MX:0x000F]
    unsigned short qclass;   //请求的资源记录的类型 一般为[IN:0x0001]
}DNS_QUERY;

typedef struct DNS_RR  
{
    char *name;   
    unsigned short type;     //请求的域名
    unsigned short _class;   //响应的资源记录的类型 一般为[IN:0x0001]
    unsigned int ttl;        //该资源记录被缓存的秒数。
    unsigned short data_len; //RDATA部分的长度
    unsigned short pre;      //MX特有的优先级 Preference
    char *rdata;             //[A:32位的IP地址（4字节）] [CNAME/NS/MX:域名]
}DNS_ResouceRecord;

typedef struct tag
{
    unsigned short qr;       //[1]标示该消息是请求消息（该位为0）还是应答消息（该位为1）
    unsigned short opcode;   //[4]0  QUERY。标准查询
    unsigned short aa;       //[1]只在响应消息中有效。该位标示响应该消息的域名服务器是该域中的权威域名服务器。因为Answer Section中可能会有很多域名
    unsigned short tc;       //[1]标示这条消息是否因为长度超过UDP数据包的标准长度512字节，如果超过512字节，该位被设置为1
    unsigned short rd;       //[1]是否递归查询。1为递归查询
    unsigned short ra;       //[1]在响应消息中清除并设置。标示该DNS域名服务器是否支持递归查询。
    unsigned short z;        //[3] 冗余res 0
    unsigned short rcode;    //[4] 0  成功的响应
}TAG;

/***********************缓冲区操作和工具***************************/
/*此函数用于向buffer中写入8bit数据
 * *buffer:指向缓冲区
 * *bufferPointer:目前已写入的缓冲区最新一位的下一位
 * 以下put16bits put32bits同理
 */
void put1Byte(char *buffer,int *bufferPointer, char value)
{
    //调整value为网络字节序
    value = htons(value);
    //void *memcpy(void *dest, void *src, unsigned int count);
    //用于 把资源内存（src所指向的内存区域） 拷贝到目标内存（dest所指向的内存区域）,count为拷贝区域大小.
    //buffer为缓冲区首地址，bufferPointer为缓冲区已写入下标，此函数参数为指向这两个量的指针，通过传递地址来实现主函数与子函数的实参传递。
    //value为欲写入缓冲区的数据(value为8bit)
    memcpy(buffer + *bufferPointer,&value,1);
    //缓冲区已写入下标向后移动，使其指向下一次写入时应该写入的位置,*bufferPointer为指针bufferPointer所指地址的内容
    *bufferPointer += 1;    
}
void put2Bytes(char *buffer,int *bufferPointer, unsigned short value)
{
    value = htons(value);
    memcpy(buffer + *bufferPointer,&value,2);
    *bufferPointer += 2;    
}
void put4Bytes(char *buffer,int *bufferPointer, unsigned int value)
{
    value = htons(value);
    memcpy(buffer + *bufferPointer,&value,4);
    *bufferPointer += 4;    
}
//将变长字符串str写入buffer  
void putDomainName(char *buffer,int *bufferPointer, char *str)
{
    memcpy(buffer + *bufferPointer,str,strlen(str)+1); //末尾0需要一起打印
    *bufferPointer += strlen(str)+1;
}
//从缓冲区取16个位
unsigned short get2Bytes(char *buffer,int *bufferPointer)
{
    unsigned short value;
    memcpy(&value,buffer + *bufferPointer,2);
    *bufferPointer += 2;

    return ntohs(value);  
}
unsigned int get4bits(char *buffer,int *bufferPointer)
{
    unsigned int value;
    memcpy(&value,buffer + *bufferPointer,4);
    *bufferPointer += 4;

    return ntohs(value);  
}
//读取变长字符串str 读取到0即停止 0即为'\0' 
//域名不考虑字节序问题 ，也不用考虑编码问题，都是一个字节一个字节读
void getDomainName(char *buffer,int *bufferPointer,int *lengthOfDomain)  
{   

    int valueWriting=0;
    while(buffer[*bufferPointer]!=0)  
    {        
        domain_temp[valueWriting] = buffer[*bufferPointer]; 
        valueWriting++;
        (*bufferPointer)++;
    }
    domain_temp[valueWriting] = 0; //末尾为0，写入字符串结束符，方便对字符数组进行字符串操作
    (*bufferPointer)++; //缓冲区读写下一位指针指示跳过末尾0
    *lengthOfDomain = valueWriting+1; //包含了末尾结束符 

}
//eg 3www6google3com0   
//生成域名编码
//一个UTF8 数字占1个字节。一个UTF8汉字占3个字节
void encode_domain(char* domain)           
{
    memset(domain_temp,0,MAX_SIZE_OF_DOMAIN);   
    int valueWriting=0;
    char *p,*q;
    q = domain;
    p = q;
    char count = 0;
    while(1)   
    {
        if((*p=='.')||(*p==0))
        {
            //第一位为count,写入字符串  
            *(domain_temp+valueWriting)=count;  //此处最后一位0的情况写入了 
            valueWriting += 1;
            //写入q开始，长度为count的字符串（长度为count)
            memcpy(domain_temp+valueWriting,q,count);
            valueWriting += count; 

            //计数清0
            count = 0;
            //如果未读到字符串末尾，将q移动到p+1的位置，重新开始下一轮
            if (*p=='.')
            {
                q=p+1;
                p = q;
            }else break;
        }else
        {
            p++;
            count++;
        }
    }
}
//解析编码的域名
void decode_domain(char* domain)
{
    memset(domain_temp,0,MAX_SIZE_OF_DOMAIN);
    int valueWriting = 0;
    char *p = domain;  
    int count = *p;
    while(count!=0)
    {
        for(int i=0;i<count;i++)
        {
            p += 1;
            domain_temp[valueWriting] = *p;
            valueWriting++;
        }
        if (*(p+1)!=0) 
        {
            domain_temp[valueWriting] = '.';
            valueWriting++;
        }
        p += 1;
        count = *p;
    }
    domain_temp[valueWriting]=0;
}

//OPCODE、Z、RCODE不用管，无论输入什么都为0。其他都是单位的
unsigned short create_tag(unsigned short qr,unsigned short opcode,unsigned short aa,unsigned short tc,unsigned short rd,unsigned short ra,unsigned short z,unsigned short rcode)
{
    unsigned short tag = 0;
    if (qr==1)  tag = tag | 0x8000;
    if (aa==1)  tag = tag | 0x0400;
    if (tc==1)  tag = tag | 0x0200;
    if (rd==1)  tag = tag | 0x0100;
    if (ra==1)  tag = tag | 0x0080;
    return tag;
}

//类型的名字与编码的转换
unsigned short strTypeToCode(char* type)
{
    if (strcmp(type,"A")==0) return 0x0001;
    if (strcmp(type,"NS")==0) return 0x0002;
    if (strcmp(type,"CNAME")==0) return 0x0005;
    if (strcmp(type,"MX")==0) return 0x000F;
    return 0;
}
char* codeTypeToStr(unsigned short num)
{
    if (num==0x0001) return "A";
    if (num==0x0002) return "NS";
    if (num==0x0005) return "CNAME";
    if (num==0x000F) return "MX";
    return "ERROR";
}

/***********************DNS头部操作***************************/
/*
 *此函数用于填充客户端发送请求的dns包的头部
 */
void create_query_header(struct DNS_Header *query_header,unsigned short id,unsigned short tag,unsigned short queryNum,unsigned short answerNum,unsigned short authorNum,unsigned short addNum)
{
    query_header->id = id;
    query_header->tag = tag;
    query_header->queryNum = queryNum;
    query_header->answerNum = answerNum;
    query_header->authorNum = authorNum;
    query_header->addNum = addNum;
}
/*此函数用于将已经填充好的dns头部结构体的成员依次写入buffer
 *  *header: 指向已填充好的dns头部结构体的指针
 *  *buffer: 指向缓冲区
 *  *bufferPointer: 目前已写入的缓冲区最新一位的下一位
 */
void encode_header(struct DNS_Header *header,char *buffer,int *bufferPointer)
{
    put2Bytes(buffer,bufferPointer,header->id);
    put2Bytes(buffer,bufferPointer,header->tag);
    put2Bytes(buffer,bufferPointer,header->queryNum);
    put2Bytes(buffer,bufferPointer,header->answerNum);
    put2Bytes(buffer,bufferPointer,header->authorNum);
    put2Bytes(buffer,bufferPointer,header->addNum);
}
void decode_header(struct DNS_Header *header,char *buffer,int *bufferPointer)
{
    header->id=get2Bytes(buffer,bufferPointer);
    header->tag=get2Bytes(buffer,bufferPointer);
    header->queryNum=get2Bytes(buffer,bufferPointer);
    header->answerNum=get2Bytes(buffer,bufferPointer);
    header->authorNum=get2Bytes(buffer,bufferPointer);
    header->addNum=get2Bytes(buffer,bufferPointer);
}
void print_header(struct DNS_Header *query_header)
{
    printf("[DNS HEADER]\n");
    printf("ID         :         %d\n",query_header->id);
    printf("TAG        :         0x%x\n",query_header->tag);
    printf("QueryNum   :         %d\n",query_header->queryNum);
    printf("AnswerNum  :         %d\n",query_header->answerNum);
    printf("AuthorNum  :         %d\n",query_header->authorNum);
    printf("AddNum     :         %d\n",query_header->addNum);
}

/***********************DNS请求部分操作***************************/
/*
 *生成DNS包的请求部分
 */
void create_query_section(struct DNS_Query *query_section,char* domain_name, unsigned short qtype, unsigned short qclass)
{
    int domain_length = strlen(domain_name);
    query_section->name = malloc(domain_length+1);
    memcpy(query_section->name,domain_name,domain_length+1);    

    query_section->qtype = qtype;
    query_section->qclass = qclass;    
}
/*
 *将已经填充好的dns的一个请求结构体的成员依次写入buffer(调用一次该函数只写入一个请求
 */
void encode_query_section(struct DNS_Query *query_section,char *buffer,int *bufferPointer)
{
    //先计算用decodeDomain得到字符串
    //再用strlen计算字符串长度为点语法name长度+2（头尾多了一个数字）
    //再发送 
    char *domain_name;
    int lengthOfEncodedDomain = strlen(query_section->name)+2;
    domain_name = malloc(lengthOfEncodedDomain);
    encode_domain(query_section->name);
    memcpy(domain_name,domain_temp,lengthOfEncodedDomain);
    putDomainName(buffer,bufferPointer,domain_name); 

    put2Bytes(buffer,bufferPointer,query_section->qtype);
    put2Bytes(buffer,bufferPointer,query_section->qclass);
}
/*
 *解析请求部分。解析即为将缓冲区的字节流提取，转码，生成对应的结构体
 */
void decode_query_section(struct DNS_Query *query_section,char *buffer,int *bufferPointer)
{
    //从缓冲区读出编码过的域名
    char* domain_name = malloc(MAX_SIZE_OF_DOMAIN); 
    memset(domain_name,0,MAX_SIZE_OF_DOMAIN);
    int lengthOfDomain=0;
    getDomainName(buffer,bufferPointer,&lengthOfDomain);
    memcpy(domain_name,domain_temp,lengthOfDomain);

    //解码域名
    decode_domain(domain_name);
    memcpy(domain_name,domain_temp,strlen(domain_name));  

    query_section->name = domain_name;
    query_section->qtype = get2Bytes(buffer,bufferPointer);
    query_section->qclass = get2Bytes(buffer,bufferPointer);
}

void print_query_section(struct DNS_Query *query_section)
{
    printf("[DNS QUERY]\n");
    printf("Name       :         %s\n",query_section->name);
    printf("Type       :         %s\n",codeTypeToStr(query_section->qtype));
    printf("Class      :         IN\n");
}

/***********************DNS RR操作和RR文件解析操作***************************/
//生成resource record记录
void create_resource_record(struct DNS_RR *resource_record,char* name, unsigned short type, unsigned short _class, unsigned int ttl, unsigned short pre,char *rdata) //data_len不用输入  
{
    //unsigned short pre为一个MX类型特有的优先级，定长，只有MX类型发送。
    int domain_length = strlen(name);
    //易错点：strlen只读到0但不包含0，所以为了把结束符也复制进去，长度要+1
    resource_record->name = malloc(domain_length+1);   
    memcpy(resource_record->name,name,domain_length+1);

    resource_record->type = type;
    resource_record->_class = _class;
    resource_record->ttl = ttl;       //data_len
    if (type==0x0001) resource_record->data_len=4;  //对于IP，长度为4 data_len是编码后的长度，length是非编码长度，注意
        else resource_record->data_len = strlen(rdata) + 2;      //对于域名，生成data_len包含末尾结束符（域名末尾结束符）

    //pre
    if (type==0x000F) {
        resource_record->pre = pre;
        resource_record->data_len += 2;  //对于邮件类型，由于有pre的存在，多占两个字节
    }

    //char* rdata
    int rdata_length = strlen(rdata);  //要加上末尾结束符
    resource_record->rdata = malloc(rdata_length+1);
    memcpy(resource_record->rdata,rdata,rdata_length+1);
}

//编码resource record记录，编码即为将结构体的内容编码，处理为字节流，写入缓冲区
void encode_resource_record(struct DNS_RR *resource_record,char *buffer,int *bufferPointer)
{
    char *domain_name;
    int lengthOfEncodedDomain = strlen(resource_record->name)+2;
    domain_name = malloc(lengthOfEncodedDomain);

    encode_domain(resource_record->name);
    memcpy(domain_name,domain_temp,lengthOfEncodedDomain);

    putDomainName(buffer,bufferPointer,domain_name); 

    put2Bytes(buffer,bufferPointer,resource_record->type);
    put2Bytes(buffer,bufferPointer,resource_record->_class);
    put4Bytes(buffer,bufferPointer,resource_record->ttl);
    put2Bytes(buffer,bufferPointer,resource_record->data_len);   
    if (resource_record->type==0x000F) 
        put2Bytes(buffer,bufferPointer,resource_record->pre);

    //如果类型为A，发送的是IP，将IP写入缓冲区               
    if(resource_record->type == 0x0001)         
    {
        //不能调用get put函数，因为inet_addr自带字节序变换功能
        unsigned int rdata = inet_addr(resource_record->rdata);
        memcpy(buffer + *bufferPointer,&rdata,4);
        *bufferPointer += 4;

    }else{          
    //如果类型为MX、CNAME、NS
    //则发送的是域名，则调用域名编码
        char *rdata;
        int lengthOfEncodedDomain2 = strlen(resource_record->rdata)+2;
        rdata = malloc(lengthOfEncodedDomain2);
        encode_domain(resource_record->rdata);
        memcpy(rdata,domain_temp,lengthOfEncodedDomain2);   
        putDomainName(buffer,bufferPointer,rdata); 
    }
}

//解析resource record记录
void decode_resource_record(struct DNS_RR *resource_record,char *buffer,int *bufferPointer)
{
    //从缓冲区读出编码过的域名
    char* domain_name = malloc(MAX_SIZE_OF_DOMAIN); 
    memset(domain_name,0,MAX_SIZE_OF_DOMAIN);
    int lengthOfDomain=0;
    getDomainName(buffer,bufferPointer,&lengthOfDomain);
    memcpy(domain_name,domain_temp,lengthOfDomain);
    //解码域名

    decode_domain(domain_name);
    memcpy(domain_name,domain_temp,strlen(domain_name));  
    resource_record->name = domain_name;

    resource_record->type = get2Bytes(buffer,bufferPointer);
    resource_record->_class = get2Bytes(buffer,bufferPointer);
    resource_record->ttl = get4bits(buffer,bufferPointer);   
    resource_record->data_len = get2Bytes(buffer,bufferPointer);
    if (resource_record->type==0x000F) 
            resource_record->pre = get2Bytes(buffer,bufferPointer);

    //如果发送的是IP（类型为A），则读出IP 。 不能采用get put方法，因为inet_ntoa方法已经更换字节序
    if(resource_record->type == 0x0001)   
    {
        unsigned int rdata;
        memcpy(&rdata,buffer + *bufferPointer,4);
        *bufferPointer += 4;

        struct in_addr in;
        memcpy(&in, &rdata, 4);  

        resource_record->rdata = malloc(MAX_SIZE_OF_DOMAIN);
        char *temp =  inet_ntoa(in);
        memcpy(resource_record->rdata,temp,strlen(temp)+1);   //+1是为了包含末尾0    
    }else{
        //如果发送的是域名，则调用域名解码（类型为CNAME NS MX）
        //从缓冲区读出编码过的域名
        char* rdata = malloc(MAX_SIZE_OF_DOMAIN); 
        int lengthOfDomain2=0;
        getDomainName(buffer,bufferPointer,&lengthOfDomain2);
        memcpy(rdata,domain_temp,lengthOfDomain2);
        //解码域名
        decode_domain(rdata);
        memcpy(rdata,domain_temp,strlen(rdata));  
        resource_record->rdata = rdata;
    }
}

void print_resource_record(struct DNS_RR *resource_record)
{
    printf("[RESOURCE RECORD]\n");
    printf("Name       :         %s\n",resource_record->name);
    printf("Type       :         %s\n",codeTypeToStr(resource_record->type));
    printf("Class      :         IN\n");
    printf("TTL        :         %d\n",resource_record->ttl);
    printf("Data_Len   :         %d\n",resource_record->data_len);
    if (resource_record->type==0x000F) 
    printf("Preference :         %d\n",resource_record->pre);
    printf("IP|DOMAIN  :         %s\n",resource_record->rdata);
    printf("===================================\n");
}

//砍掉一个域名第一个.之前的部分,如果已经是最后一节，指向域名的指针指向NULL
void cut(char** domainPointer)  //这里传入的是 指向指向域名的指针的指针
{
    while(1)
    {
        (*domainPointer)++;
        if (**domainPointer=='.')
        {
            (*domainPointer)++;
            break;        
        }
        if (**domainPointer==0)
        {
            *domainPointer = NULL;
            break;
        }
    }
}

/***********************文件读写***************************/
//将RR写进cache文件里
void addRRToCache(struct DNS_RR *resource_record, char* cacheFile)
{
    FILE *RR = fopen(cacheFile, "a+");
    fprintf(RR,"%s         ",resource_record->name);
    fprintf(RR,"%d         ",resource_record->ttl);
    fprintf(RR,"IN         ");
    fprintf(RR,"%s         ",codeTypeToStr(resource_record->type));
    fprintf(RR,"%s\n",resource_record->rdata);
    fclose(RR);
}

//第一次在RR文件里扫描 （初次搜索函数）
//如果找到了，返回1，且encode进buffer
int firstFindRR(struct DNS_Query *query_section,char *RRDOCUMENT,char *buffer,int *bufferPointer)
{
    int over = 0;
    FILE *RR = fopen( RRDOCUMENT, "r" );
    //定义一个RR结构体用来储存从文件中读入的一条RR
    struct DNS_RR *fileRR;
    fileRR = malloc(sizeof(DNS_ResouceRecord));
    memset(fileRR,0,sizeof(DNS_ResouceRecord));
    fileRR->name=malloc(MAX_SIZE_OF_DOMAIN);  
    fileRR->rdata=malloc(MAX_SIZE_OF_DOMAIN);
    //第一次搜索
    while(fscanf(RR,"%s ",fileRR->name)!=EOF)   
    {
        fscanf(RR,"%d",&fileRR->ttl);
        char type[10],_class[10];
        fscanf(RR,"%s ",_class);
        fscanf(RR,"%s ",type);
        fileRR->type = strTypeToCode(type);
        fscanf(RR,"%s\n",fileRR->rdata);

        if((strcmp(query_section->name,fileRR->name)==0) && (query_section->qtype==fileRR->type))
        {
            printf("\n发送回复：\n");
            //生成answer RR
            create_resource_record(fileRR,fileRR->name, fileRR->type, 0x0001, fileRR->ttl, 0x0000,fileRR->rdata);
            //生成头
            struct DNS_Header *header;
            header = malloc(sizeof(DNS_HEAD));
            unsigned short tag = create_tag(1,0,1,0,0,0,0,0);
            if (strcmp(type,"MX")==0)   create_query_header(header,0x1235,tag,0,1,0,1);
                else create_query_header(header,999,tag,0,1,0,0);
            //将头和answer encode进buffer
            encode_header(header,buffer,bufferPointer);
            print_header(header);
            encode_resource_record(fileRR,buffer,bufferPointer);
            print_resource_record(fileRR);
            over=1;
            break;
        }
    }

    //读指针回到开头
    fseek(RR,0,0);
    //对于MX类型，特殊，需要再搜索一遍，搜索到的邮件服务器域名的IP，并写入addition RR中发送    
    if ((fileRR->type==0x000F)&&(over==1)) 
    {
        struct DNS_RR *addFileRR;
        addFileRR = malloc(sizeof(DNS_ResouceRecord));
        addFileRR->name=malloc(MAX_SIZE_OF_DOMAIN);
        addFileRR->rdata=malloc(MAX_SIZE_OF_DOMAIN);
        while(fscanf(RR,"%s ",addFileRR->name)!=EOF)
        {
            fscanf(RR,"%d ",&addFileRR->ttl);
            char type[10],_class[10];
            fscanf(RR,"%s ",_class);
            fscanf(RR,"%s ",type);
            addFileRR->type = strTypeToCode(type);
            fscanf(RR,"%s\n",addFileRR->rdata);
            if(strcmp(fileRR->rdata,addFileRR->name)==0)
            {
                printf("邮件服务器：\n");
                //生成addition RR
                create_resource_record(addFileRR,fileRR->rdata, 1, 1, fileRR->ttl, 0, addFileRR->rdata);
                encode_resource_record(addFileRR,buffer,bufferPointer);
                print_resource_record(addFileRR);
                break;
            }
        }    
    }
    fclose(RR);
    return over;
}

void loopFindNS(struct DNS_Query *query_section,char *RRDOCUMENT,char *buffer,int *bufferPointer)
{
    FILE *RR = fopen( RRDOCUMENT, "r" );
    cut(&query_section->name);
    //剪掉首段地址，进行第二次搜索
    while(query_section->name!=NULL)
    {
        fseek(RR,0,0);  

        struct DNS_RR *nextRR;
        nextRR = malloc(sizeof(DNS_ResouceRecord));
        nextRR->name=malloc(MAX_SIZE_OF_DOMAIN);
        nextRR->rdata=malloc(MAX_SIZE_OF_DOMAIN);
        while(fscanf(RR,"%s ",nextRR->name)!=EOF)
        {
            fscanf(RR,"%d ",&nextRR->ttl);
            char type[10],_class[10];
            fscanf(RR,"%s ",_class);
            fscanf(RR,"%s ",type);
            nextRR->type = strTypeToCode(type);
            fscanf(RR,"%s\n",nextRR->rdata);
            if(strcmp(query_section->name,nextRR->name)==0)
            {
                printf("\n下一级服务器信息：\n");
                //生成头
                struct DNS_Header *header;
                header = malloc(sizeof(DNS_HEAD));
                unsigned short tag = create_tag(1,0,1,0,0,0,0,0);
                create_query_header(header,999,tag,0,0,1,1);
                encode_header(header,buffer,bufferPointer);
                print_header(header);

                //生成authority RR  NS记录type=2   此时query_section->name经过cut后已经变成了下一个要去的DNS服务器域名
                struct DNS_RR *authRR;
                authRR = malloc(sizeof(DNS_ResouceRecord));
                create_resource_record(authRR, query_section->name, 2, 1, nextRR->ttl, 0, query_section->name);
                encode_resource_record(authRR,buffer,bufferPointer);
                print_resource_record(authRR);

                //生成additon RR   A记录type=1
                struct DNS_RR *addRR;
                addRR = malloc(sizeof(DNS_ResouceRecord));
                create_resource_record(addRR, query_section->name, 1, 1, nextRR->ttl, 0, nextRR->rdata);
                encode_resource_record(addRR,buffer,bufferPointer);
                print_resource_record(addRR);

                goto out;
            }
        }    
        cut(&query_section->name);    
    }
    out:
    fclose(RR);
}
</code></pre>

        </div>
        <!-- .entry-content -->
        <div class="single-reward">
          <div class="reward-open">赏
            <div class="reward-main">
              <ul class="reward-row">
                <li class="alipay-code"><img src="/images/donate/AliPayQR.jpg"></li>
                <li class="wechat-code"><img src="/images/donate/WeChanQR.jpg"></li>
              </ul>
            </div>
          </div>
        </div>
        <div style="text-align:center; width: 100%" class="social-share share-mobile" data-disabled="diandian, tencent"></div>
        <footer class="post-footer">
          <div class="post-lincenses"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="nofollow"><i class="fa fa-creative-commons" aria-hidden="true"></i> 知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a></div>
          <div class="post-tags">
          </div>
          <div class="post-share">
            <div class="social-share sharehidden share-component"></div>
            <i class="iconfont show-share icon-forward"></i>
          </div>
        </footer><!-- .entry-footer -->
      </article>
      <!-- #post-## -->
      <div class="toc" style="background: none;"></div>
      <section class="post-squares nextprev">
        
          
            <div class="post-nepre half previous">
          
            <a href="/网络与云/多级中文域名解析系统-2（c语言）/" rel="prev">
              <div class="background">
                <img class="lazyload" src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/loader/orange.progress-bar-stripe-loader.svg" data-src="" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="imgError(this,3)" src="">
              </div>
              <span class="label">
              Previous Post</span>
              <div class="info">
                <h3>
                多级中文域名解析系统-2</h3>
                <hr>
              </div>
            </a>
          </div>
        
        
          
            <div class="post-nepre half next">
          
            <a href="/日记/2018/" rel="next">
              <div class="background">
                <img class="lazyload" src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/loader/orange.progress-bar-stripe-loader.svg" data-src="" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="imgError(this,3)" src="">
              </div>
              <span class="label">
              Next Post</span>
              <div class="info">
                <h3>
                2018</h3>
                <hr>
              </div>
            </a>
          </div>
        
      </section>
      
<div id="vcomments"></div>
<script>
  window.onload = function(){
      var valine = new Valine();
      valine.init({
        el: '#vcomments',
        appId: "d2ULHdiL7VOfJf17rpCD4DOX-gzGzoHsz",
        appKey: "OLf7QaP1oTtqKhulLHuajYKu",
        path: window.location.pathname,
        placeholder: "你是我一生只会遇见一次的惊喜 ..."
      })
  }
</script>

      <section class="author-profile">
        <div class="info" itemprop="author" itemscope="" itemtype="https://schema.org/Person">
          <a href="" class="profile gravatar"><img src="" itemprop="image" alt="" height="70" width="70"></a>
          <div class="meta">
            <span class="title">Author</span>
            <h3 itemprop="name">
            <a href="" itemprop="url" rel="author"></a>
            </h3>
          </div>
        </div>
        <hr>
        <p><i class="iconfont icon-write"></i></p>
      </section>
    </main><!-- #main -->
  </div><!-- #primary -->
</div>



    </div>    
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            // PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
    <!-- <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 aisaka<br>
      powered_by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer> -->
<footer id="colophon" class="site-footer" role="contentinfo">
  <div class="site-info">
    <div class="footertext">
      <div class="img-preload">
        <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/wordpress-rotating-ball-o.svg">
        <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/disqus-preloader.svg">
      </div>
      <p style="color: #666666;">&copy 2016~2021</p>
    </div>
    <div class="footer-device">
    <p style="font-family: 'Ubuntu', sans-serif;">
        <span style="color: #b9b9b9;">
          aisaka
        </span>
      </p>
    </div>
  </div><!-- .site-info -->
</footer>



<!-- <script src="/js/tocbot.js"></script> -->
<script type="text/javascript" src="/js/lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script type="text/javascript" src="/js/InsightSearch.js"></script>
<script type="text/javascript" src="/js/jquery.fancybox.min.js"></script>
<script type="text/javascript" src="/js/zoom.min.js"></script>
<script type="text/javascript" src="/js/sakura-app.js"></script>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='//unpkg.com/valine@1.3.4/dist/Valine.min.js'></script>
<script src="/js/botui.js"></script>
<!-- 不蒜子 网页计数器 -->
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script> -->
<script type="text/javascript">
/* <![CDATA[ */
if (/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  var Poi = {"pjax":"1","movies":{"url": "","name":"","live":"close"},"windowheight":"fixed","codelamp":"close","ajaxurl":"","order":"asc","formpostion":"bottom"};
} else {
  var Poi = {"pjax":"1","movies":{"url": "","name":"","live":"open"},"windowheight":"auto","codelamp":"close","ajaxurl":"","order":"asc","formpostion":"bottom"};
}
/* ]]> */

</script>
<script>
$(document).ready(function() {
  if ($(".toc").length > 0 && document.body.clientWidth > 1200) {
    if ($(".pattern-center").length > 0) { //有图的情况
      tocbot.init({
          // Where to render the table of contents.
          tocSelector: '.toc', // 放置目录的容器
          // Where to grab the headings to build the table of contents.
          contentSelector: '.entry-content', // 正文内容所在
          // Which headings to grab inside of the contentSelector element.
          scrollSmooth: true,
          headingSelector: 'h1, h2, h3, h4, h5', // 需要索引的标题级别
          headingsOffset: -400,
          scrollSmoothOffset: -85
      });
    } else {
      tocbot.init({
          // Where to render the table of contents.
          tocSelector: '.toc', // 放置目录的容器
          // Where to grab the headings to build the table of contents.
          contentSelector: '.entry-content', // 正文内容所在
          // Which headings to grab inside of the contentSelector element.
          scrollSmooth: true,
          headingSelector: 'h1, h2, h3, h4, h5', // 需要索引的标题级别
          headingsOffset: -85,
          scrollSmoothOffset: -85
      });
    }
    var offsetTop = $('.toc').offset().top - 95;
    window.onscroll = function() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop;
      if (scrollTop >= offsetTop) {
        $('.toc').addClass('toc-fixed');
      } else {
        $('.toc').removeClass('toc-fixed');
      }
    }
  }
});
</script>

    <div class="openNav no-select" style="height: 50px;">
      <div class="iconflat no-select" style="width: 50px; height: 50px;">
        <div class="icon"></div>
      </div>
      <div class="site-branding search-form-submit">
        <i class="iconfont js-toggle-search iconsearch icon-search"></i>
      </div>
    </div>
  </section>
  <div id="mo-nav" class="">
  <div class="m-avatar">
    <img src="/images/img/000.jpg">
  </div>
  <p style="text-align: center; color: #333; font-weight: 900; font-family: 'Ubuntu', sans-serif; letter-spacing: 1.5px">宵晓咲</p>
  <p style="text-align: center; word-spacing: 20px;">
    
  </p>
  <ul id="menu-new-1" class="menu">
    
      <li>
        <a href="/">
          <span class="faa-parent animated-hover">
            <i class="fa  " aria-hidden="true"></i>
            首页
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/archives">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-fort-awesome faa-shake" aria-hidden="true"></i>
            时间线
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="javascript:;">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-archive faa-shake" aria-hidden="true"></i>
            ACG
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/categories/Anime/">
                  <i class="fa " aria-hidden="true"></i>
                  动画
                </a>
              </li>
            
              <li>
                <a href="/categories/Game/">
                  <i class="fa " aria-hidden="true"></i>
                  游戏
                </a>
              </li>
            
              <li>
                <a href="/categories/Music/">
                  <i class="fa " aria-hidden="true"></i>
                  音乐
                </a>
              </li>
            
              <li>
                <a href="/categories/游戏设计/">
                  <i class="fa " aria-hidden="true"></i>
                  游戏设计
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="javascript:;">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-book faa-shake" aria-hidden="true"></i>
            随想
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/categories/日记/">
                  <i class="fa " aria-hidden="true"></i>
                  日记
                </a>
              </li>
            
              <li>
                <a href="/categories/阅读/">
                  <i class="fa " aria-hidden="true"></i>
                  阅读
                </a>
              </li>
            
              <li>
                <a href="/categories/随笔/">
                  <i class="fa " aria-hidden="true"></i>
                  随笔
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="javascript:;">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-code faa-shake" aria-hidden="true"></i>
            技术
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/categories/程序语言/">
                  <i class="fa " aria-hidden="true"></i>
                  程序
                </a>
              </li>
            
              <li>
                <a href="/categories/人工智能/">
                  <i class="fa " aria-hidden="true"></i>
                  人工智能
                </a>
              </li>
            
              <li>
                <a href="/categories/开发/">
                  <i class="fa " aria-hidden="true"></i>
                  开发
                </a>
              </li>
            
              <li>
                <a href="/categories/数据库与中间件/">
                  <i class="fa " aria-hidden="true"></i>
                  中间件
                </a>
              </li>
            
              <li>
                <a href="/categories/网络与云/">
                  <i class="fa " aria-hidden="true"></i>
                  网络
                </a>
              </li>
            
              <li>
                <a href="/categories/算法与数据结构/">
                  <i class="fa " aria-hidden="true"></i>
                  算法
                </a>
              </li>
            
              <li>
                <a href="/categories/计算机理论/">
                  <i class="fa " aria-hidden="true"></i>
                  CS
                </a>
              </li>
            
              <li>
                <a href="/categories/论文阅读笔记/">
                  <i class="fa " aria-hidden="true"></i>
                  论文
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="javascript:;">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-leaf faa-wrench" aria-hidden="true"></i>
            其它
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/categories/硬件/">
                  <i class="fa " aria-hidden="true"></i>
                  硬件
                </a>
              </li>
            
              <li>
                <a href="/categories/博客/">
                  <i class="fa " aria-hidden="true"></i>
                  博客
                </a>
              </li>
            
              <li>
                <a href="/categories/工具/">
                  <i class="fa " aria-hidden="true"></i>
                  工具
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="javascript:;">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-list-ul faa-vertical" aria-hidden="true"></i>
            清单
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/tags/悦读/">
                  <i class="fa fa-th-list faa-bounce" aria-hidden="true"></i>
                  书单
                </a>
              </li>
            
              <li>
                <a href="/bangumi/">
                  <i class="fa fa-film faa-vertical" aria-hidden="true"></i>
                  番组
                </a>
              </li>
            
              <li>
                <a href="/music/">
                  <i class="fa fa-headphones" aria-hidden="true"></i>
                  歌单
                </a>
              </li>
            
              <li>
                <a href="/tags/图集/">
                  <i class="fa fa-photo" aria-hidden="true"></i>
                  图集
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="/comment/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-pencil-square-o faa-tada" aria-hidden="true"></i>
            留言板
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/links/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-link faa-shake" aria-hidden="true"></i>
            Link
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/about/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-meetup faa-shake" aria-hidden="true"></i>
            我
          </span>
        </a>
        
      </li>
    
  </ul>
  <p style="text-align: center; font-size: 13px; color: #b9b9b9;">&copy 2019 hexo-sakura</p>
</div>
<button onclick="topFunction()" class="mobile-cd-top" id="moblieGoTop" title="Go to top" style="display: none;"><i class="fa fa-chevron-up" aria-hidden="true"></i></button>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<!-- require MetingJS -->
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
<style>
  .aplayer .aplayer-lrc {
    height: 35px;
  }
  .aplayer .aplayer-lrc p{
    font-size: 16px;
    font-weight: 700;
    line-height: 18px !important;
  }
  .aplayer .aplayer-lrc p.aplayer-lrc-current{
    color: #FF1493;
  }
  .aplayer.aplayer-narrow .aplayer-body{
    left: -66px !important;
  }
  .aplayer.aplayer-fixed .aplayer-lrc {
    display: none;
  }
  .aplayer .aplayer-lrc.aplayer-lrc-hide {
      display:none !important;
  }
  .aplayer.aplayer-fixed .lrc-show {
    display: block;
    background: rgba(255, 255, 255, 0.8);
  }
</style>
<meting-js

    id=""

    server="netease"

    type="playlist"

    fixed="true"

    autoplay="false"

    loop="all"

    order="random"

    preload="auto"

    volume="0.7"

    mutex="true"

</meting-js>
<!--这里我want aplayer失效-->
<script>
  $(function(){
    $('body').on('click', '.aplayer', function(){
      if($('.aplayer-button').hasClass('aplayer-play')) {
        $('.aplayer-lrc').removeClass('lrc-show');
      } else {
        $('.aplayer-lrc').addClass('lrc-show');
      }
    })
  });
</script>

</body>
</html>